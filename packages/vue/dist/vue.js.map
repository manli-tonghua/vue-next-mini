{"version":3,"file":"vue.js","sources":["../../shared/src/index.ts","../../reactivity/src/dep.ts","../../reactivity/src/effect.ts","../../reactivity/src/baseHandlers.ts","../../reactivity/src/reactive.ts","../../reactivity/src/ref.ts","../../reactivity/src/computed.ts"],"sourcesContent":["export const isArray  = Array.isArray\n\nexport const isObject = (val: unknown) : boolean => val !== null && typeof val === 'object'\nexport const hasChanged = (value: any, oldValue: any) => !Object.is(value, oldValue)\nexport const isFunction = (val: unknown) : boolean => typeof val === 'function'","import { ReactiveEffect } from \"./effect\";\n\nexport type Dep = Set<ReactiveEffect>\n\nexport const createDep = (effects?: ReactiveEffect[]): Dep => {\n    const dep = new Set<ReactiveEffect>(effects) as Dep\n    return dep\n}","import { ComputedRefImpl } from \"./computed\"\nimport { createDep, Dep } from \"./dep\"\n\ntype KeyToDepMap = Map<any, Dep>\n\nconst targetMap = new WeakMap<any, KeyToDepMap>()\n\nexport type EffectScheduler = (...args: any[]) => any\n\nexport function track(target: object, key: unknown){\n    // 如果当前不存在执行函数，则直接返回\n    if(!activeEffect) return\n    // 尝试从targetMap中，根据target获取map\n    let depsMap = targetMap.get(target)\n    // 如果获取到的 map 不存在，则生成新的 map 对象，并把该对象赋值给对应的value\n    if(!depsMap) {\n        targetMap.set(target, (depsMap = new Map()))\n    }\n    let dep = depsMap.get(key)\n    if(!dep) {\n        depsMap.set(key, (dep = createDep()))\n    }\n    trackEffects(dep)\n}\n\n/**利用 dep 依次跟踪指定key的所有effect */\nexport function trackEffects(dep: Dep) {\n    dep.add(activeEffect!)\n}\n\n/**\n * 触发依赖的方法\n * @param target  WeakMap 的 key\n * @param key 代理对象的key,当依赖被触发时， 需要根据该key获取\n */\nexport function trigger(target: object, key: unknown){\n    // 依据 target 获取存储的map实例\n    const depsMap = targetMap.get(target)\n    if(!depsMap) return\n    // 依据 key, 从depsMap中取出value，该value是一个ReactiveEffect类型的数据\n    const dep: Dep | undefined = depsMap.get(key)\n    if(!dep) {\n        return\n    }\n    triggerEffects(dep)\n}\n\n/**\n * \n * @param 依次触发dep中保存的依赖\n */\nexport function triggerEffects(dep: Dep) {\n    const effects = Array.isArray(dep) ? dep : Array.from(dep)\n    // 依次触发依赖\n    for(const effect of effects) {\n        if(effect.computed) {\n            triggerEffect(effect)\n        }\n    }\n    for (const effect of effects) {\n        if(!effect.computed) {\n            triggerEffect(effect)\n        }\n    }\n}\n\nexport function triggerEffect(effect: ReactiveEffect) {\n    if(effect.scheduler) {\n        effect.scheduler()\n    }else {\n        effect.run()\n    }\n}\n\nexport let activeEffect: ReactiveEffect | undefined\n\nexport class ReactiveEffect<T = any> {\n    computed?: ComputedRefImpl<T>\n    constructor(public fn: () => T, public scheduler: EffectScheduler | null = null) {}\n    run() {\n        activeEffect = this\n        return this.fn()\n    }\n\n}\nexport function effect<T = any>(fn: () => T) {\n    const _effect = new ReactiveEffect(fn)\n    _effect.run()\n}","import { track, trigger } from \"./effect\"\n\n/**\n * getter回调方法\n */\nconst get = createGetter()\n/**\n * 创建getter回调方法\n */\nfunction createGetter() {\n    return function get(target: object, key: string | symbol, receiver: object ) {\n        \n        // 利用 Reflect 得到返回值\n        const res = Reflect.get(target, key, receiver)\n        // 收集依赖\n        track(target, key)\n        return res \n    }\n}\n\nconst set = createSetter()\n\nfunction createSetter() {\n    return function set(target: object, key: string | symbol, value: any, receiver: object) {\n        // 利用 Reflect 设置新值\n        const res = Reflect.set(target, key, value, receiver)\n        // 触发依赖\n        trigger(target, key)\n        return res\n    }\n}\n\nexport const mutableHandlers: ProxyHandler<object> = {\n    get,\n    set\n}\n\n","import { isObject } from \"packages/shared/src/index\";\nimport { mutableHandlers } from \"./baseHandlers\";\n/**\n * 响应性 Map缓存对象\n * key target\n * val proxy\n */\nexport const reactiveMap = new WeakMap<object, any>()\n\n/**\n * 为复杂数据类型，创建响应性对象\n * @param target 被代理对象\n * @returns 代理对象\n */\nexport function reactive(target: object) {\n    return createReactiveObject(target, mutableHandlers, reactiveMap)\n}\n\nfunction createReactiveObject(\n    target: object, \n    baseHandlers: ProxyHandler<any>, \n    proxyMap: WeakMap<object, any>) {\n\n        // 如果该实例已经被代理，则直接返回\n        const existingProxy = proxyMap.get(target)\n        if(existingProxy) {\n            return existingProxy\n        }\n        // 未被代理则生成proxy实例\n        const proxy = new Proxy(target, baseHandlers)\n        // 缓存代理对象\n        proxyMap.set(target, proxy)\n        return proxy\n    }\n\nexport const toReactive = <T extends unknown>(value: T): T => {\n    return isObject(value) ? reactive(value as object) : value\n}","import { hasChanged } from \"packages/shared/src/index\"\nimport { createDep, Dep } from \"./dep\"\nimport { activeEffect, trackEffects, triggerEffects } from \"./effect\"\nimport { toReactive } from \"./reactive\"\n\nexport interface Ref<T = any> {\n    value: T\n}\n\nexport function ref (value?: unknown) {\n    return createRef(value, false)\n}\n\nexport function createRef(rawValue: unknown, shallow: boolean) {\n    if(isRef(rawValue)) {\n        return rawValue\n    }\n    return new RefImpl(rawValue, shallow)\n}\n\nclass RefImpl<T> {\n    private _value: T\n    private _rawValue: T\n\n    public dep?: Dep = undefined\n\n    public readonly __v_isRef = true\n    constructor (value: T, public readonly __v_isShallow: boolean) {\n        this._rawValue = value\n        // 如果 __v_isShallow 为 true，则 value 不会被转化为 reactive 数据，即如果当前 value 为复杂数据类型，则会失去响应性。对应官方文档 shallowRef ：https://cn.vuejs.org/api/reactivity-advanced.html#shallowref\n        this._value = __v_isShallow ? value : toReactive(value)\n    }\n    get value() {\n        trackRefValue(this)\n        return this._value\n    }\n\n    set value(newVal) {\n        if(hasChanged(newVal, this._rawValue)) {\n            this._rawValue = newVal\n            this._value = toReactive(newVal)\n            triggerRefValue(this)\n        }\n    }\n}\n\nexport function triggerRefValue(ref) {\n    if(ref.dep) {\n        triggerEffects(ref.dep)\n    }\n}\n\nexport function trackRefValue (ref) {\n    if(activeEffect) {\n        trackEffects(ref.dep || (ref.dep = createDep()))\n    }\n}\n\nexport function isRef(r: any): r is Ref {\n    return !!(r && (r as any).__v_isRef === true)\n}","import { isFunction } from \"packages/shared/src/index\"\nimport { Dep } from \"./dep\"\nimport { ReactiveEffect } from \"./effect\"\nimport { trackRefValue, triggerRefValue } from \"./ref\"\n\nexport class ComputedRefImpl<T> {\n    public dep?: Dep = undefined\n    private _value!: T\n    public readonly effect: ReactiveEffect<T>\n    public readonly __v_isRef = true\n    public _dirty = true\n\n    constructor(getter) {\n        this.effect = new ReactiveEffect(getter, () => {\n            if(!this._dirty) {\n                this._dirty = true\n                triggerRefValue(this)\n            }\n        })\n        this.effect.computed = this\n    }\n    get value() {\n        trackRefValue(this)\n        if(this._dirty) {\n            this._dirty = false\n            this._value = this.effect.run()\n        }\n        return this._value\n    }\n}\n\nexport function computed (getterOrOptions) {\n    let getter\n    const onlyGetter = isFunction(getterOrOptions)\n    if(onlyGetter) {\n        getter = getterOrOptions\n    }\n    const cRef = new ComputedRefImpl(getter)\n    return cRef\n}"],"names":[],"mappings":"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"}